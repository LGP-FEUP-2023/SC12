{"version":3,"sources":["module.android.ts"],"names":["NativeModules","PermissionsAndroid","Core","RESULTS","uniq","RNP","RNPermissions","coreStatusToStatus","status","GRANTED","DENIED","BLOCKED","UNAVAILABLE","openSettings","check","permission","available","includes","isNonRequestable","request","rationale","setNonRequestable","splitByAvailability","permissions","unavailable","index","length","push","checkNotifications","checkMultiple","dedup","output","blocklist","getNonRequestables","Promise","all","map","granted","requestMultiple","toSetAsNonRequestable","statuses","hasOwnProperty","setNonRequestables","module","requestNotifications"],"mappings":"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","sourcesContent":["import {\n  NativeModules,\n  Permission as CorePermission,\n  PermissionsAndroid as Core,\n  PermissionStatus as CoreStatus,\n  Rationale,\n} from 'react-native';\nimport {RESULTS} from './constants';\nimport {Contract} from './contract';\nimport {NotificationsResponse, Permission, PermissionStatus} from './types';\nimport {uniq} from './utils';\n\nconst RNP: {\n  available: Permission[];\n\n  checkNotifications: () => Promise<NotificationsResponse>;\n  openSettings: () => Promise<true>;\n  getNonRequestables: () => Promise<Permission[]>;\n  isNonRequestable: (permission: Permission) => Promise<boolean>;\n  setNonRequestable: (permission: Permission) => Promise<true>;\n  setNonRequestables: (permissions: Permission[]) => Promise<true>;\n} = NativeModules.RNPermissions;\n\nfunction coreStatusToStatus(status: CoreStatus): PermissionStatus {\n  switch (status) {\n    case 'granted':\n      return RESULTS.GRANTED;\n    case 'denied':\n      return RESULTS.DENIED;\n    case 'never_ask_again':\n      return RESULTS.BLOCKED;\n    default:\n      return RESULTS.UNAVAILABLE;\n  }\n}\n\nasync function openSettings(): Promise<void> {\n  await RNP.openSettings();\n}\n\nasync function check(permission: Permission): Promise<PermissionStatus> {\n  if (!RNP.available.includes(permission)) {\n    return RESULTS.UNAVAILABLE;\n  }\n\n  if (await Core.check(permission as CorePermission)) {\n    return RESULTS.GRANTED;\n  }\n\n  return (await RNP.isNonRequestable(permission))\n    ? RESULTS.BLOCKED\n    : RESULTS.DENIED;\n}\n\nasync function request(\n  permission: Permission,\n  rationale?: Rationale,\n): Promise<PermissionStatus> {\n  if (!RNP.available.includes(permission)) {\n    return RESULTS.UNAVAILABLE;\n  }\n\n  const status = coreStatusToStatus(\n    await Core.request(permission as CorePermission, rationale),\n  );\n\n  if (status === RESULTS.BLOCKED) {\n    await RNP.setNonRequestable(permission);\n  }\n\n  return status;\n}\n\nfunction splitByAvailability<P extends Permission[]>(\n  permissions: P,\n): {\n  unavailable: Partial<Record<P[number], PermissionStatus>>;\n  available: P[number][];\n} {\n  const unavailable: Partial<Record<P[number], PermissionStatus>> = {};\n  const available: P[number][] = [];\n\n  for (let index = 0; index < permissions.length; index++) {\n    const permission: P[number] = permissions[index];\n\n    if (RNP.available.includes(permission)) {\n      available.push(permission);\n    } else {\n      unavailable[permission] = RESULTS.UNAVAILABLE;\n    }\n  }\n\n  return {unavailable, available};\n}\n\nfunction checkNotifications(): Promise<NotificationsResponse> {\n  return RNP.checkNotifications();\n}\n\nasync function checkMultiple<P extends Permission[]>(\n  permissions: P,\n): Promise<Record<P[number], PermissionStatus>> {\n  const dedup = uniq(permissions);\n  const {unavailable: output, available} = splitByAvailability(dedup);\n  const blocklist = await RNP.getNonRequestables();\n\n  await Promise.all(\n    available.map(async (permission: P[number]) => {\n      const granted = await Core.check(permission as CorePermission);\n\n      output[permission] = granted\n        ? RESULTS.GRANTED\n        : blocklist.includes(permission)\n        ? RESULTS.BLOCKED\n        : RESULTS.DENIED;\n    }),\n  );\n\n  return output as Record<P[number], PermissionStatus>;\n}\n\nasync function requestMultiple<P extends Permission[]>(\n  permissions: P,\n): Promise<Record<P[number], PermissionStatus>> {\n  const toSetAsNonRequestable: Permission[] = [];\n  const dedup = uniq(permissions);\n  const {unavailable: output, available} = splitByAvailability(dedup);\n  const statuses = await Core.requestMultiple(available as CorePermission[]);\n\n  for (const permission in statuses) {\n    if (statuses.hasOwnProperty(permission)) {\n      const status = coreStatusToStatus(statuses[permission as CorePermission]);\n      output[permission as P[number]] = status;\n\n      status === RESULTS.BLOCKED &&\n        toSetAsNonRequestable.push(permission as Permission);\n    }\n  }\n\n  if (toSetAsNonRequestable.length > 0) {\n    await RNP.setNonRequestables(toSetAsNonRequestable);\n  }\n\n  return output as Record<P[number], PermissionStatus>;\n}\n\nexport const module: Contract = {\n  openSettings,\n  check,\n  request,\n  checkNotifications,\n  requestNotifications: checkNotifications,\n  checkMultiple,\n  requestMultiple,\n};\n"]}